# Limited Dependent Variable Models

This chapter covers three regression models in which the dependent variable is somehow limited:

1. Truncation: With truncated data, the researcher does not observe values past a particular point and those values are also not reported. Examples of truncation are low-income household studies, on-site visitation data, or time-of-use pricing experiments (excludes low-usage households). 

2. Censoring: In the case of censoring, values that are above or below a certain value are replaced by that value. For example, the demand for a particular class is not fully observed (absence of a waiting list). This is also called a Tobit model. 

3. Count dependent variable 

The following packages are necessary for this section: [AER](https://cran.r-project.org/web/packages/AER/index.html) [truncreg](https://cran.r-project.org/web/packages/truncreg/index.html), [censReg](https://cran.r-project.org/web/packages/censReg/index.html), and [pscl](https://cran.r-project.org/web/packages/pscl/index.html).

Truncation and censoring lead to a bias in the estimates. It is not always clear why or if the data is limited in its range. 

## Truncation
In the case of truncation, a certain part of the data is not observed. In the graph below, the true parameters are $\beta_0=-2$ and $\beta_1=0.5$. Values $y<0$ are not reported in the data. The green regression line is "correct" whereas the "red" is the line obtained from a regression model which ignores the truncation.  

```{r truncationplot, echo=FALSE}
bhat_real           = lm(y_real~x,data=truncation)
bhat_truncated      = lm(y_obs~x,data=truncation)
plot(truncation$x,truncation$y_obs,xlim=c(0,10),ylim=c(-3,5),pch=19,ylab="y",xlab="x")
     points(truncation$x,truncation$y_real)
     abline(bhat_real,col=c("darkgreen"))
     abline(bhat_truncated,col=c("red"))
```
If all the data was observed, the correct regression model would give the following results:
```{r truncation_bhat_real}
summary(bhat_real)
```

The estimates are biased if truncation is ignored:
```{r truncation_bhat_incorrect}
summary(bhat_truncated)

```

To correct for the truncation, use the functions from the package [truncreg](https://cran.r-project.org/web/packages/truncreg/index.html) which allows to reduce the bias of the coefficients:

```{r truncation_bhat_correct}
bhat_correct = truncreg(y_obs~x,data=truncation)
summary(bhat_correct)
```

## Censoring
In the case of censoring, the values of the dependent variable are reported at a certain point if they are above or below a certain value.

```{r, echo=FALSE}
bhat_real = lm(y_real~x,data=censoring)
bhat_censored = lm(y_obs~x,data=censoring)
plot(censoring$x,censoring$y_real)
     points(censoring$x,censoring$y_obs,pch=19)
     abline(bhat_real,col=c("darkgreen"))
     abline(bhat_censored,col=c("red"))
```

If all data was reported at the correct value, the following following regression model could be executed: 
```{r}
summary(bhat_real)
```

Ignoring censoring leads to biased results:
```{r}
summary(bhat_censored)
```

Using the R package [censReg](https://cran.r-project.org/web/packages/censReg/index.html)) allows for the reduction of the bias:
```{r}
b_correct = censReg(y_obs~x,data=censoring)
summary(b_correct)
```

## Count Regression Models
Count regression models apply to cases in which the dependent variable represents discrete, integer count data. Here are some examples of count outcomes:

- What are the number of arrests for a person?
- What determines the number of credit cards a person owns? 

This section on count regression presents three models:

1. Poisson Regression Model: The condition to use this model is the absence of overdispersion, i.e., the expected value of the dependent variable is equal to the variance. 
2. Quasi-Poisson Regression Model: Overdispersion occurs if the variance of the dependent variable is larger than its mean. In this case, the Poisson Regression Model leads to unreliable hypothesis tests regarding the coefficients. The Quasi-Poisson Model solves this issue.
2. Negative Binomial Regression Model: The second possibility to deal with overdispersion is to use a Negative Binomial Regression Model. 

The main package used is [pscl](https://cran.r-project.org/web/packages/pscl/index.html). There is also an additional resource with more theoretical details on the topic: [Regression Models for Count Data in R](http://dx.doi.org/10.18637/jss.v027.i08). A more up-to-date version of the document may be found with the [pscl](https://cran.r-project.org/web/packages/pscl/index.html) package documentation. 

### Poisson Regression Model
Recall that the Poisson distribution is written as:
$$Pr(Y=k)=\frac{e^{-\lambda} \cdot \lambda^k}{k!}$$
The important characteristics of the distribution is that the mean and variance are equal to $\lambda$, i.e., $E(Y)=\lambda$ and $Var(Y)=\lambda$, this is also known as the equidispersion property. The  mean parameter is written as $\lambda=exp(\beta_0+\beta_1 \cdot x_1+ \dots + \beta_k \cdot x_k)$.

The first examples uses the 2017 [NHTS](https://nhts.ornl.gov/) data contained in `hhpub`. In a first step, the data is prepared for the regression model, i.e., missing or unknown values are eliminated and income is measured in (thousand) dollar terms:

```{r poissonregression_cleanhhpub,results=FALSE}
hhpubdata = subset(hhpub,HHFAMINC %in% c(1:11) & HOMEOWN %in% c(1,2) & URBRUR %in% c(1,2) & HHVEHCNT %in% c(0:12))
HHFAMINC = c(1:11)
INCOME = c(10,12.5,20,30,42.5,57.5,82.5,112.5,137.5,175,200)
INCOME = data.frame(HHFAMINC,INCOME)
hhpubdata = merge(hhpubdata,INCOME)
hhpubdata$RURAL = hhpubdata$URBRUR-1
hhpubdata$RENT = hhpubdata$HOMEOWN-1
```

The outcome of interest is the number of vehicles based on household income, home ownership, and urban/rural household location. Before executing the Poisson regression model, calculate the mean and variance of the outcome variable.

```{r, echo=FALSE}
mean(hhpubdata$HHVEHCNT)
var(hhpubdata$HHVEHCNT)
```
The mean and the variance are similar and thus, estimating a Poisson Regression Model is an appropriate first step. The package [AER](https://cran.r-project.org/web/packages/AER/index.html) also contains the function `dispersiontest()` which conducts a hypothesis test assuming no overdispersion. This test will be used after execution of the main regression. To estimate the model, the `glm()` function can be used by specifying `family=poisson`.

```{r }
bhat_pois = glm(HHVEHCNT~INCOME+RENT+RURAL,data=hhpubdata,family=poisson)
summary(bhat_pois)
```

All coefficients are statistically significant. The signs associated with the coefficients indicates the direction of influence on the outcome variable, i.e., the number of cars. As expected, higher income is associated with a higher number of cars and so is living in a rural environment. Renting is associated with a lower number of vehicles. Note that income and renting is possibly correlated. In general, the coefficient estimates are interpreted using $\exp(\beta)$. That is, with every unit increase in $X$, the predictor variable has a multiplicative effect of $\exp(\beta)$ on the mean of $Y$, i.e., $\lambda$:

- If $\beta=0$, then $\exp(\beta) = 1$, and the expected count $\mu= E(y) = \exp(\alpha)$, and Y and X are not related.
- If $\beta>0$, then $\exp(\beta) > 1$, and the expected count $E(y)$ is $\exp(\beta)$ times larger than when $X = 0$
- If $\beta<0$, then $\exp(\beta) < 1$, and the expected count $E(y)$ is $\exp(\beta)$ times smaller than when $X = 0$

The function `overdispersion` tests the null hypothesis of equidispersion:

```{r}
dispersiontest(bhat_pois)
```

Given the *p*-value, the null hypothesis cannot be rejected. If the data suggests overdispersion, two alternative regression models can be used: (1) Quasi-Poisson and (2) Negative Binomial.

### Quasi-Poisson Regression Model
The dataset `blm` used in this section as well as the one describing the negative binomial model is associated with the article [Black Lives Matter: Evidence that Police-Caused Deaths Predict Protest Activity](https://doi.org/10.1017/S1537592717004273). Note that the paper includes a significant number of supplementary materials which allows for the replication of the results and much more.  

The dependent variable is the total number of protests in a city. In a first step, the mean and variance of the variable $totalprotests$ are calclated:

```{r}
mean(blm$totprotests)
var(blm$totprotests)
```
The variance is significantly higher than the mean which suggests overdispersion. In a first step, a regular Poisson model is estimated.

```{r}
eq1 = "totprotests~log(pop)+log(popdensity)+percentblack+blackpovertyrate+I(blackpovertyrate^2)+percentbachelor+collegeenrollpc+demshare"
bhat1 = glm(eq1,data=blm,family=poisson)
summary(bhat1)
```
Note that the signs and statistical significance correspond to Model 1 (Table 3) in the original paper. The coefficients are different because the paper only include negative binomial regression models. The reason for not using a Poisson regression model is the presence of overdispersion:
```{r}
dispersiontest(bhat1)
```
Note that the null hypothesis is rejected at the 10\% but not the 5\% significance level. The Quasi-Poisson Regression Model handles overdispersion by adjusting the stand-errors but leaving the coefficicent estimates the same.

```{r}
bhat2 = glm(eq1,data=blm,family=quasipoisson)
summary(bhat2)
```
Note that in this case, the population density is not statistically significant anymore. 

### Negative Binomial Regression Model
The Negative Binomial Regression Model can be used in the presence of count data and overdispersion. Below, the results from the article [Black Lives Matter: Evidence that Police-Caused Deaths Predict Protest Activity](https://doi.org/10.1017/S1537592717004273) are recreated using the negative binomial models presented in the paper. The required package is [MASS](https://cran.r-project.org/web/packages/MASS/index.html)

The first model is a basic model of resource mobilization and opportunity structure.
```{r}
bhat3 = glm.nb(eq1,data=blm,link=log)
summary(bhat3) 
```

In a second model, black deaths are added:
```{r}
bhat4 = glm.nb(totprotests~log(pop)+log(popdensity)+percentblack+blackpovertyrate+I(blackpovertyrate^2)+percentbachelor+collegeenrollpc+demshare+deathsblackpc,data=blm,link=log)
summary(bhat4) 
```

And in the third model, the authors use all police-caused deaths instead (victims of any race):
```{r}
bhat5 = glm.nb(totprotests~log(pop)+log(popdensity)+percentblack+blackpovertyrate+I(blackpovertyrate^2)+percentbachelor+collegeenrollpc+demshare+deathspc,data=blm,link=log)
summary(bhat5) 
```

## Exercises

1. `Aptitude Tobit Model`: Consider the censored data set in `tobit`. The aptitude score is limited at 800. Estimate an appropriate model with $apt$ as the dependent variable and $read$, $math$, and program as the independent variables. Make sure to convert $prog$ into dummy variables first.

2. `Chicago Grocery Stores`: One subdivision of Chicago are so-called Chicago Community Areas (CCA). The data in `chicagogrocery` includes data about the number of grocery stores ($stores$) in each CCA as well as demographic information. Estimate a Poisson and Negative Binomial Regression Model with $stores$ as the dependent variable and the following independent variables: $income$, $pop$, unemployment rate ($unemployed/laborforce$) and percentage of blacks ($black/pop$). What do you conclude? Are the results what you would expect?